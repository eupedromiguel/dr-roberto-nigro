rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =====================================
    // USUÁRIOS (dados privados)
    // =====================================
    match /usuarios/{userId} {

      // VISUALIZAÇÃO:
      // - Admin pode ver tudo
      // - Usuário só vê seus próprios dados
      // - Pacientes e visitantes NÃO podem ler docs de médicos aqui
      allow read: if 
          (request.auth != null && request.auth.token.role == "admin") ||
          (request.auth != null && request.auth.uid == userId);

      // CRIAÇÃO DO PRÓPRIO DOCUMENTO
      allow create: if request.auth != null &&
                     request.auth.uid == userId &&
                     !("role" in request.resource.data);

      // ATUALIZAÇÃO: não permitir alterar a role
      allow update: if request.auth != null &&
                     request.auth.uid == userId &&
                     request.resource.data.role == resource.data.role;

      // DELETE: apenas o próprio usuário
      allow delete: if request.auth != null &&
                     request.auth.uid == userId;
    }

    // =====================================
    // MÉDICOS PÚBLICOS
    // =====================================
    match /medicos_publicos/{id} {

      // Qualquer pessoa pode ver (página pública)
      allow read: if true;

      // Apenas admin pode escrever
      allow write: if request.auth != null &&
                    request.auth.token.role == "admin";
    }

    // =====================================
    // HORÁRIOS DOS MÉDICOS
    // =====================================
    match /availability_slots/{slotId} {
      allow read: if request.auth != null;

      allow create: if request.auth != null &&
                    request.auth.uid == request.resource.data.medicoId &&
                    request.auth.token.role == "doctor";

      allow update, delete: if request.auth != null &&
                            request.auth.uid == resource.data.medicoId &&
                            request.auth.token.role == "doctor";
    }

    // =====================================
    // CONSULTAS (appointments)
    // =====================================
    match /appointments/{appointmentId} {

      allow create: if request.auth != null &&
                     request.auth.uid == request.resource.data.pacienteId &&
                     request.auth.token.role == "patient" &&
                     (request.resource.data.unidade is string);

      allow read: if request.auth != null &&
                  (
                    request.auth.uid == resource.data.pacienteId ||
                    request.auth.uid == resource.data.medicoId ||
                    request.auth.token.role == "admin"
                  );

      allow update: if request.auth != null &&
                    (
                      request.auth.uid == resource.data.pacienteId ||
                      request.auth.uid == resource.data.medicoId
                    ) &&
                    request.resource.data.pacienteId == resource.data.pacienteId &&
                    request.resource.data.medicoId == resource.data.medicoId &&
                    request.resource.data.status in [
                        "agendado", "cancelada", "concluida", "retorno"
                    ];

      allow delete: if request.auth != null &&
                    (
                      request.auth.uid == resource.data.pacienteId ||
                      request.auth.uid == resource.data.medicoId
                    );
    }

    // =====================================
    // CONVÊNIOS / PLANOS DE SAÚDE
    // =====================================
    match /planos_saude/{convenioId} {
      allow read: if true;
      allow write: if request.auth != null &&
                    request.auth.token.role == "admin";

      match /categorias/{catId} {
        allow read: if true;
        allow write: if request.auth != null &&
                      request.auth.token.role == "admin";
      }
    }

    // =====================================
    // ADMIN GLOBAL (fallback)
    // =====================================
    match /{document=**} {
      allow read, create, update: if request.auth != null &&
                                   request.auth.token.role == "admin";
    }
  }
}
